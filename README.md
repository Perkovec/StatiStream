# StatiStream

Инструмент для стриминга видеозаписи на стриминговые платформы с управлением и уведомлениями через бота телеграмм

Список возможностей:
- Стриминг на Twitch
- Работа с записями с локального диска или объектного хранилища S3
- Возмоность указать логику отбора видеозаписи для стриминга: случайное видео, в порядке, указанном в конфигурации
- Управление через телеграмм бота: запуск стрима, установка ключа трансляции, остановка стрима, перезагрузка списка видео (если загрузили в хранилище новые видеозаписи и хотите чтобы сервис добавил их в пул отбора), переключение видео, статистика стриминга
- Безопасность: сервис не хранит постоянно ваш ключ трансляции, вам нужно его будет указывать через бота каждый раз

Планы для реализации:
- Работа с метаданными: возможность указать для каждой видеозаписи метаданные в виде категорий и заголовка, чтобы сервис сам изменял категории стрима и название трансляции
- Добавить стриминг на YouTube

## Как использовать

### Установка сервиса

Скачать подходящую версию можно на странице релизов

Или, если у вас в системе есть установленный Go, то можно установить через команду
```bash
go get github.com/Perkovec/StatiStream
```

### Установка зависимостей

Для работы стриминга нужно установить инстурмент ffmpeg
Страница загрузки находится здесь https://ffmpeg.org/download.html

### Создание бота

Откройте в телеграмме бота `@BotFather`, введите `/newbot` и следуйте инструкциям, в конце вам выдадут вам токен формата `11111111111:HYLdsbalugLYGWUGSdhbhaKBUYwgdygddhjs`

Далее вам нужно включить inline режим для бота, для этого у `@BotFather` введите команду `/setinline`, в предложенном списке выберите своего бота и следуйте инструкциям

Создайте текстовый файл (например `bot_key.txt`) рядом с файлом запуска сервиса и запишите туда токен бота

### Конфигурация сервиса

Создайте файл конфигураций `config.yaml`, создайте его рядом с файлом сервиса. Вот описание файла конфигурации:
```yaml
# На какие платформы делать стрим
platforms: ['twitch']

# Путь до ffmpeg, если он находиться в $PATH то можно просто указать название команды для его вызова
ffmpeg_path: ffmpeg

# Настройки для бота
bot:
    # Путь до файла с токеном бота
    token: ./bot_key.txt
    # Список ID пользователей, допущенных до управления трансляциями, свой ID можно узнать у бота @userinfobot
    accepted_users:
        - 1111111111
        - 2222222222

# Настройка источника видеозаписей
source:
    # Тип источника: s3 (объектное хранилище) или disk (локальный диск)
    type: s3

    # Настройки для работы с s3
    s3bucket: streams # Название бакета со видеозапиями
    s3endpoint: https://s3.storage.selcloud.ru # Адрес объектного хранилища
    s3credentials: # Учетные данные для работы с объектным хранилищем
        id: 111111
        secret: 222222
    s3region: ru-1 # Регион бакета

    # Общие настройки для s3 и disk
    directory_path: / # Путь до папки с видеозапиями
    files: # Список файлов видеозаписей, если не указан, то будут воспроизводится все видеозаписи из directory_path
     - chipi.flv
     - chapa.flv
    pick_strategy: random # способ выбора видеозаписи для стрима: random - случайный выбор, seq - в том порядке что указано в files или по дате создания
```

### Подготовка видеозаписей

Сервис не занимается кодировкой видеозаписей для стрима чтобы не нагружать систему на которой она запущено, тем самым сервис можно запускать даже на слабом железе

Поэтому надо предварительно подготовить видеозаписи для использования их сервисом, делается это через ffmpeg, вот пример:
```bash
ffmpeg -i путь_до_файла -c:v libx264 -preset slow -b:v 5000k -maxrate 5000k -bufsize 6000k -vf "format=yuv420p" -g 50 -c:a aac -b:a 128k -ac 2 -ar 44100 выходной_файл.flv
```
К сожалению кодировка идет силами процессора, но если у вас есть видеокарта NVidia с последними драйверами, то можно использовать аппаратную кодировку:
```bash
ffmpeg -hwaccel cuda -i путь_до_файла -c:v h264_hvenc -preset slow -b:v 5000k -maxrate 5000k -bufsize 6000k -vf format=yuv420p -g 50 -c:a aac -b:a 128k -ac 2 -ar 44100 выходной_файл.flv
```
Это значительно ускорит процесс кодировки

Теперь полученные файлы можно загружать в объектное хранилище или на диск и использовать для стрима

### Запуск сервиса

Для запуска используется следующая команда в терминале
```bash
путь_до_statistream stream путь_до_конфига.yaml
```

Например
```bash
./StatiStream stream config.yaml
```

### Использование бота

Нужно перейти к боту, которогов ысоздали и ввести команду `/start`, бот вам ответит и появятся кнопки для управления сервисом. Чтобы установить ключ трансляции введите в поле ввода ник вашего бота (с символом @) и через пробел ключ трансляции, у вас появится плашка чтобы добавить этот ключ для Twitch, нажмите на него и отправится зашифрованное сообщение, бот его распознает и извлечет из него ключ трансляции, в случае успеха бот сообщит вам об этом. Теперь можно нажимать кнопку `Запустить` и следовать инструкциям бота. Для всех "чувствительных" операций сделано подтверждение действия, так что бояться что случайно нажали на какую-то кнопку не нужно.